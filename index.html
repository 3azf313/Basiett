<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بسيط لتدوين الديون</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
         /* Font definition */
         @font-face { font-family: 'Amiri'; src: url('https://fonts.gstatic.com/s/amiri/v20/J7aRnpd8CGxBHqUrtLs.ttf') format('truetype'); font-weight: normal; font-style: normal; }
         @font-face { font-family: 'Amiri'; src: url('https://fonts.gstatic.com/s/amiri/v20/J7acnpd8CGxBHp2VkZY4xIA.ttf') format('truetype'); font-weight: bold; font-style: normal; }

        /* Color Variables (Light Mode - Default) */
        :root { --bg-primary: #ffffff; --bg-secondary: #f3f4f6; --bg-accent: #4f46e5; --bg-card-base: var(--bg-primary); --bg-card-neutral: #f3f4f6; --bg-card-positive: #faf5ff; --bg-card-negative: #fef2f2; --bg-card-paid: #f0fdf4; --text-primary: #111827; --text-secondary: #6b7280; --text-accent: #ffffff; --text-positive: #9333ea; --text-negative: #dc2626; --text-paid: #16a34a; --border-color: #e5e7eb; --shadow-color-rgb: 0, 0, 0; --modal-overlay-bg: rgba(0, 0, 0, 0.5); --input-bg: var(--bg-primary); --input-border: var(--border-color); --button-secondary-bg: #e5e7eb; --button-secondary-text: #374151; --options-hover-bg: #f3f4f6; --sidebar-bg: var(--bg-primary); }
        /* Dark Mode Overrides (Smart Invert Focus) */
        html.dark { --bg-primary: #1f2937; --bg-secondary: #000000; --bg-accent: #4f46e5; --bg-card-base: var(--bg-primary); --bg-card-neutral: var(--bg-primary); --bg-card-positive: var(--bg-primary); --bg-card-negative: var(--bg-primary); --bg-card-paid: var(--bg-primary); --text-primary: #f9fafb; --text-secondary: #9ca3af; --text-accent: #ffffff; --text-positive: #c084fc; --text-negative: #f87171; --text-paid: #4ade80; --border-color: #4b5563; --shadow-color-rgb: 200, 200, 200; --modal-overlay-bg: rgba(0, 0, 0, 0.7); --input-bg: #374151; --input-border: #6b7280; --button-secondary-bg: #4b5563; --button-secondary-text: var(--text-primary); --options-hover-bg: #374151; --sidebar-bg: #111827; }

        /* Base styles */
        body { background-color: var(--bg-secondary); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
        #app-content, .modal-content:not(#image-viewer-modal .modal-content):not(#about-modal .modal-content):not(#debt-options-modal .modal-content) { font-family: 'Amiri', sans-serif; }
        #about-modal .modal-content p, #about-modal .modal-content strong, #debt-options-modal .modal-content button span { font-family: 'Amiri', sans-serif; }
        #app-container > div { background-color: var(--bg-primary); box-shadow: 0 10px 15px -3px rgba(var(--shadow-color-rgb), 0.1), 0 4px 6px -2px rgba(var(--shadow-color-rgb), 0.05); }
        #app-header { background-color: var(--bg-accent); color: var(--text-accent); } #app-header button:not(.menu-button) { background-color: var(--bg-primary); color: var(--bg-accent); } #app-header button.menu-button { background-color: transparent; color: var(--text-accent); }
        .debt-item-base { background-color: var(--bg-card-base); } .debt-item-neutral { background-color: var(--bg-card-neutral); } .debt-item-positive { background-color: var(--bg-card-positive); } .debt-item-negative { background-color: var(--bg-card-negative); } .debt-item-paid { background-color: var(--bg-card-paid); }
        .text-status-positive { color: var(--text-positive); } .text-status-negative { color: var(--text-negative); } .text-status-paid { color: var(--text-paid); } .text-status-neutral { color: var(--text-secondary); }
        .modal-overlay { background-color: var(--modal-overlay-bg); z-index: 30; padding: 1rem; position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;} .modal-content { background-color: var(--bg-primary); color: var(--text-primary); border-radius: 0.5rem; padding: 1.5rem; width: 100%; margin: 1rem; } .modal-content h3 { color: var(--text-primary); } .modal-content label { color: var(--text-primary); }
        .modal-content input[type="text"], .modal-content input[type="number"], .modal-content textarea, #sidebar select, #add-debt-form input, #add-debt-form textarea { background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem; width: 100%; }
        .modal-content input::placeholder, .modal-content textarea::placeholder, #add-debt-form input::placeholder, #add-debt-form textarea::placeholder { color: var(--text-secondary); } #add-debt-form label { color: var(--text-primary); } #add-debt-form { background-color: var(--bg-primary); }
        button.cancel-button { background-color: var(--button-secondary-bg); color: var(--button-secondary-text); } button.confirm-button { background-color: var(--bg-accent); color: var(--text-accent); } button.delete-button { background-color: #dc2626; color: white; }
        .hidden { display: none; } .options-popup { background-color: var(--bg-primary); box-shadow: 0 4px 6px -1px rgba(var(--shadow-color-rgb), 0.1), 0 2px 4px -1px rgba(var(--shadow-color-rgb), 0.06); z-index: 10; } .options-popup button:hover { background-color: var(--options-hover-bg); } .file-input-label { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text-secondary); } .file-input-label:hover { background-color: var(--input-border); } .person-card { position: relative; border-color: var(--border-color); } .border-t { border-top-color: var(--border-color); }
        .text-gray-500 { color: var(--text-secondary); } .text-gray-600 { color: var(--text-primary); } .text-gray-700 { color: var(--text-primary); } .bg-gray-100 { background-color: var(--bg-secondary); } .bg-gray-200 { background-color: var(--button-secondary-bg); } .bg-white { background-color: var(--bg-primary); } .bg-indigo-600 { background-color: var(--bg-accent); } .text-white { color: var(--text-accent); } .text-indigo-600 { color: var(--bg-accent); } .bg-red-600 { background-color: #dc2626;} .bg-green-600 { background-color: #16a34a;} .bg-blue-500 { background-color: #3b82f6;} .bg-gray-500 { background-color: #6b7280;} .hover\:bg-blue-600:hover { background-color: #2563eb;} .hover\:bg-gray-600:hover { background-color: #4b5563;} .text-yellow-600 { color: #ca8a04 !important; }

        /* Sidebar Styles */
        #sidebar-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; transition: opacity 0.3s ease-in-out; opacity: 0; pointer-events: none; } #sidebar-overlay.active { opacity: 1; pointer-events: auto; } #sidebar { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background-color: var(--sidebar-bg); box-shadow: -2px 0 8px rgba(var(--shadow-color-rgb), 0.15); z-index: 50; padding: 1.5rem 1rem; transition: right 0.3s ease-in-out; overflow-y: auto; color: var(--text-primary); } html[dir="ltr"] #sidebar { right: auto; left: -300px; transition: left 0.3s ease-in-out; box-shadow: 2px 0 8px rgba(var(--shadow-color-rgb), 0.15); } #sidebar.active { right: 0; } html[dir="ltr"] #sidebar.active { left: 0; } #sidebar h2 { font-size: 1.25rem; font-weight: bold; margin-bottom: 1.5rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; } #sidebar a, #sidebar button.sidebar-item { display: flex; align-items: center; padding: 0.75rem 0.5rem; margin-bottom: 0.5rem; border-radius: 0.375rem; color: var(--text-primary); text-decoration: none; transition: background-color 0.2s ease; width: 100%; text-align: right; } html[dir="ltr"] #sidebar a, html[dir="ltr"] #sidebar button.sidebar-item { text-align: left; } #sidebar a:hover, #sidebar button.sidebar-item:hover { background-color: var(--bg-secondary); } #sidebar a svg, #sidebar button.sidebar-item svg { margin-left: 0.75rem; width: 1.25rem; height: 1.25rem; flex-shrink: 0; color: var(--text-secondary); } html[dir="ltr"] #sidebar a svg, html[dir="ltr"] #sidebar button.sidebar-item svg { margin-left: 0; margin-right: 0.75rem; } #sidebar .divider { height: 1px; background-color: var(--border-color); margin: 1rem 0; } #sidebar .select-group label { display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem; } .switch { position: relative; display: inline-block; width: 44px; height: 24px; } .switch input { opacity: 0; width: 0; height: 0; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; } html.dark .slider { background-color: var(--border-color); } .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: var(--bg-accent); } input:checked + .slider:before { transform: translateX(20px); }

        /* About & Image Modals */
        #about-modal .modal-content { max-width: 42rem; background-color: var(--bg-primary); } #about-modal h3 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: var(--bg-accent); } #about-modal p { margin-bottom: 1rem; line-height: 1.6; color: var(--text-primary);} #about-modal strong { font-weight: bold; color: var(--text-primary); } #about-modal button svg { stroke: var(--text-primary); }
        #image-viewer-modal .modal-content { padding: 0.5rem; background-color: transparent; max-width: 95%; box-shadow: none; overflow: visible; position: relative; } #image-viewer-img { display: block; max-width: 100%; max-height: 90vh; margin: auto; object-fit: contain; } #image-viewer-close { position: absolute; top: -5px; left: -5px; background-color: rgba(0, 0, 0, 0.6); color: white; border-radius: 9999px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; z-index: 35; } .receipt-image-container { cursor: pointer; }

        /* Confirmation & Debt Options Modal Styles */
        #confirmation-modal .modal-content, #debt-options-modal .modal-content { max-width: 24rem; padding: 1.5rem; }
        #debt-options-modal .modal-content ul { list-style: none; padding: 0; margin: 0; } #debt-options-modal .modal-content li button { display: block; width: 100%; text-align: right; padding: 0.75rem 1rem; margin-bottom: 0.5rem; border-radius: 0.375rem; background-color: transparent; border: 1px solid var(--border-color); color: var(--text-primary); transition: background-color 0.2s ease; display: flex; align-items: center; } #debt-options-modal .modal-content li button svg { margin-left: 0.75rem; } html[dir="ltr"] #debt-options-modal .modal-content li button { text-align: left; } html[dir="ltr"] #debt-options-modal .modal-content li button svg { margin-left: 0; margin-right: 0.75rem; }
        #debt-options-modal .modal-content li button:hover { background-color: var(--options-hover-bg); } #debt-options-modal .modal-content li button.text-status-paid, #debt-options-modal .modal-content li button.text-yellow-600 { border-color: transparent; } #debt-options-modal .modal-content li button.text-status-paid:hover { background-color: rgba(22, 163, 74, 0.1); } #debt-options-modal .modal-content li button.text-yellow-600:hover { background-color: rgba(202, 138, 4, 0.1); } #debt-options-modal .modal-content li button.text-status-negative { border-color: transparent; background-color: var(--text-negative); color: white; } #debt-options-modal .modal-content li button.text-status-negative:hover { background-color: #b91c1c; }

        /* Print Styles */
        @media print { /* ... (Print styles remain the same) ... */ body { margin: 0; padding: 0; font-family: 'Amiri', sans-serif !important; background-color: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } .max-w-md { max-width: none !important; margin-left: 0 !important; margin-right: 0 !important; box-shadow: none !important; border: none !important; overflow: visible !important; } .p-4 { padding: 0 !important; } #app-header, #person-list-view, #show-add-debt-button, #add-debt-form, .options-toggle, #print-button-details, .modal-overlay, #sidebar-overlay, #sidebar, #debt-options-modal, #confirmation-modal { display: none !important; } #person-detail-view { display: block !important; position: static !important; margin: 0 !important; padding: 10mm !important; box-shadow: none !important; border: none !important; width: 100% !important; font-family: 'Amiri', sans-serif !important; box-sizing: border-box; } #person-detail-view #debts-container > div { box-shadow: none !important; border: 1px solid #ccc !important; page-break-inside: avoid !important; margin-bottom: 0.5rem !important; } #person-detail-view .debt-item-paid { background-color: #f0fdf4 !important; } #person-detail-view .debt-item-positive { background-color: #faf5ff !important; } #person-detail-view .debt-item-negative { background-color: #fef2f2 !important; } #person-detail-view .text-status-paid { color: #16a34a !important; } #person-detail-view .text-status-positive { color: #9333ea !important; } #person-detail-view .text-status-negative { color: #dc2626 !important; } #person-detail-view .text-secondary { color: #6b7280 !important; } #person-detail-view .text-primary { color: #111827 !important; } #person-detail-view::before { content: "كشف حساب: " attr(data-person-name); display: block; text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; font-family: 'Amiri', sans-serif !important; } #person-detail-view #person-summary { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #ccc !important; } #person-detail-view .receipt-image-container { width: 13rem !important; height: 13rem !important; } #person-detail-view .receipt-image-container img { width: 100% !important; height: 100% !important; object-fit: contain !important; border: 1px solid #eee; vertical-align: middle; } }
    </style>
</head>
<body class="bg-secondary">

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay"></div>

    <!-- Sidebar -->
    <div id="sidebar"> <h2 data-translate="settings">الإعدادات</h2> <div class="flex items-center justify-between mb-4 px-2"> <span class="flex items-center"> <svg class="ml-2" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> <span data-translate="darkMode">الوضع الداكن</span> </span> <label class="switch"> <input type="checkbox" id="dark-mode-toggle"> <span class="slider"></span> </label> </div> <div class="select-group mb-4 px-2"> <label for="currency-select" data-translate="currency">العملة</label> <select id="currency-select"> <option value="ل.س">ل.س (ليرة سورية)</option> <option value="د.ع">د.ع (دينار عراقي)</option> <option value="$">USD   </option> <option value="€">EUR  </option> </select> </div> <div class="select-group mb-4 px-2"> <label for="language-select" data-translate="language">اللغة</label> <select id="language-select"> <option value="ar">العربية</option> <option value="en">English</option> <option value="de">Deutsch</option> </select> </div> <div class="mb-4 px-2">
        <button class="sidebar-item" id="open-import-export">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            <span data-translate="importExportDebts">استيراد وتصدير الديون</span>
        </button>
    </div>
<div class="divider"></div> <button class="sidebar-item" id="show-about-button"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg> <span data-translate="aboutApp">لمحة عن التطبيق</span> </button> </div>


    <!-- Main App Container -->
     <div class="p-4 min-h-screen" id="app-container"> <div class="max-w-md mx-auto bg-primary rounded-lg shadow-lg overflow-hidden">
            <!-- Header -->
            <div id="app-header" class="bg-indigo-600 text-white p-4 flex justify-between items-center">
                <button id="menu-button" class="p-1 menu-button"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg> </button>
                <!-- Title container -->
                <div class="flex-grow text-center">
                    <h1 id="header-title" class="text-xl font-bold" data-translate="appTitle">بسيط لتدوين الديون</h1>
                </div>
                <button id="close-person-view" class="bg-white text-indigo-600 rounded p-1 hidden"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> </button>
            </div>
            <!-- Main Content Area -->
            <div id="app-content">
                 <!-- Person List View -->
                 <div id="person-list-view" class="p-4"> <div id="persons-container" class="space-y-3 mb-4"></div> <div id="add-person-form" class="bg-white p-3 rounded-lg shadow-md hidden mb-4"> <input type="text" id="new-person-name-input" data-translate-placeholder="personNamePlaceholder" placeholder="اسم الشخص" class="w-full p-2 border rounded mb-2"/> <div class="flex justify-end space-x-2 space-x-reverse"> <button id="cancel-add-person" class="cancel-button px-3 py-1 rounded" data-translate="cancel">إلغاء</button> <button id="confirm-add-person" class="confirm-button px-3 py-1 rounded" data-translate="add">إضافة</button> </div> </div> <button id="show-add-person-button" class="bg-indigo-600 text-white px-4 py-2 rounded-full shadow flex items-center justify-center w-full"> <svg class="ml-1" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> <span data-translate="addNewPerson">إضافة شخص جديد</span> </button> <div id="total-summary" class="mt-6 pt-4 border-t"> <div class="flex justify-between items-center"> <h3 class="font-bold" data-translate="totalBalance">المجموع الكلي:</h3> <span id="total-debt-amount" class="font-bold text-lg text-status-neutral">0</span> </div> <div id="total-debt-status" class="text-sm text-status-neutral" data-translate="noDebts">لا توجد ديون</div> </div> </div>
                 <!-- Person Detail View -->
                 <div id="person-detail-view" class="p-4 hidden" data-person-name=""> <div id="debts-container" class="space-y-3 mb-4"></div> <div id="add-debt-form" class="bg-primary p-3 rounded-lg shadow-md hidden mb-4"> <div class="mb-3"><label class="block text-sm font-medium mb-1" data-translate="amount">المبلغ</label><input type="number" id="new-debt-amount" data-translate-placeholder="enterAmountPlaceholder" placeholder="أدخل المبلغ" class="w-full p-2 border rounded"/></div> <div class="mb-3"><label class="block text-sm font-medium mb-1" data-translate="note">ملاحظة</label><textarea id="new-debt-note" data-translate-placeholder="addNotePlaceholder" placeholder="أضف ملاحظة (اختياري)" class="w-full p-2 border rounded" rows="2"></textarea></div> <div class="mb-3"><label class="block text-sm font-medium mb-1" data-translate="receipt">وصل الدين</label><div id="new-debt-receipt-preview-container" class="border rounded p-2 flex items-center justify-center bg-gray-50 min-h-[8rem]"></div><input type="file" accept="image/*" id="new-debt-receipt-input" class="hidden"></div> <div class="mb-3 flex space-x-4 space-x-reverse"> <label class="flex items-center cursor-pointer"><input type="radio" name="newDebtType" value="owedToMe" checked class="ml-1"><span class="ml-2" data-translate="debtForMe">دين لصالحي</span></label> <label class="flex items-center cursor-pointer"><input type="radio" name="newDebtType" value="owedByMe" class="ml-1"><span id="new-debt-owed-by-me-label" class="ml-2" data-translate="debtForPerson">دين لصالح الشخص</span></label> </div> <div class="flex justify-end space-x-2 space-x-reverse"> <button id="cancel-add-debt" class="cancel-button px-3 py-1 rounded" data-translate="cancel">إلغاء</button> <button id="confirm-add-debt" class="confirm-button px-3 py-1 rounded" disabled data-translate="add">إضافة</button> </div> </div> <button id="show-add-debt-button" class="bg-indigo-600 text-white px-4 py-2 rounded-full shadow flex items-center justify-center w-full mb-6"> <svg class="ml-1" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> <span data-translate="addNewDebt">إضافة دين جديد</span> </button> <div id="person-summary" class="mt-6 pt-4 border-t space-y-2"></div> <div class="mt-6"> <button id="print-button-details" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-full shadow flex items-center justify-center w-full"> <svg class="ml-1" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer-fill" viewBox="0 0 16 16"> <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/> <path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/> </svg> <span data-translate="printStatement">طباعة كشف الحساب</span> </button> </div> </div>
            </div>
             <!-- Modals -->
             <div id="confirmation-modal" class="modal-overlay hidden"> <div class="modal-content max-w-sm w-full"> <h3 class="text-lg font-bold mb-4" data-translate="confirmationTitle">تأكيد الإجراء</h3> <p class="mb-6" id="confirmation-message">هل أنت متأكد؟</p> <div class="flex justify-end space-x-2 space-x-reverse"> <button id="cancel-confirmation-btn" class="cancel-button px-4 py-2 rounded" data-translate="cancel">إلغاء</button> <button id="confirm-action-btn" class="confirm-button bg-green-600 px-4 py-2 rounded" data-translate="confirm">تأكيد</button> </div> </div> </div>
             <div id="debt-options-modal" class="modal-overlay hidden"> <div class="modal-content max-w-xs w-full"> <ul id="debt-options-list"> {/* Options will be added here by JS */} </ul> <button id="cancel-debt-options" class="cancel-button w-full mt-4 px-4 py-2 rounded" data-translate="cancel">إلغاء</button> </div> </div>
             <div id="edit-debt-modal" class="modal-overlay hidden"> <div class="modal-content"> <h3 class="text-lg font-bold mb-4" data-translate="editDebt">تعديل الدين</h3><input type="hidden" id="edit-debt-id"> <div class="mb-3"><label class="block text-sm font-medium mb-1" data-translate="amount">المبلغ</label><input type="number" id="edit-debt-amount" placeholder="أدخل المبلغ" class="w-full p-2 border rounded"/></div> <div class="mb-3"><label class="block text-sm font-medium mb-1" data-translate="note">ملاحظة</label><textarea id="edit-debt-note" placeholder="أضف ملاحظة (اختياري)" class="w-full p-2 border rounded" rows="2"></textarea></div> <div class="mb-3"><label class="block text-sm font-medium mb-1" data-translate="receipt">وصل الدين</label><div id="edit-debt-receipt-preview-container" class="border rounded p-2 flex items-center justify-center bg-gray-50 min-h-[8rem]"></div><input type="file" accept="image/*" id="edit-debt-receipt-input" class="hidden"></div> <div class="mb-3 flex space-x-4 space-x-reverse"> <label class="flex items-center cursor-pointer"><input type="radio" name="editDebtType" value="owedToMe" class="ml-1"><span class="ml-2" data-translate="debtForMe">دين لصالحي</span></label> <label class="flex items-center cursor-pointer"><input type="radio" name="editDebtType" value="owedByMe" class="ml-1"><span id="edit-debt-owed-by-me-label" class="ml-2" data-translate="debtForPerson">دين لصالح الشخص</span></label> </div> <div class="flex justify-between space-x-2 space-x-reverse"> <button id="delete-debt-from-edit" class="delete-button px-3 py-1 rounded" data-translate="deleteDebt">حذف الدين</button> <div><button id="cancel-edit-debt" class="cancel-button px-3 py-1 rounded ml-2" data-translate="cancel">إلغاء</button><button id="confirm-update-debt" class="confirm-button px-3 py-1 rounded" disabled data-translate="saveChanges">حفظ التغييرات</button></div> </div> </div> </div>
             <div id="edit-person-modal" class="modal-overlay hidden"> <div class="modal-content max-w-sm w-full"> <h3 class="text-lg font-bold mb-4" data-translate="editPersonName">تعديل اسم الشخص</h3><input type="hidden" id="edit-person-id"> <div class="mb-3"><label for="edit-person-name-input" class="block text-sm font-medium mb-1" data-translate="name">الاسم</label><input type="text" id="edit-person-name-input" placeholder="أدخل الاسم الجديد" class="w-full p-2 border rounded"/></div> <div class="flex justify-end space-x-2 space-x-reverse mt-6"> <button id="cancel-edit-person" class="cancel-button px-3 py-1 rounded" data-translate="cancel">إلغاء</button> <button id="confirm-update-person" class="confirm-button px-3 py-1 rounded" disabled data-translate="saveChanges">حفظ التغييرات</button> </div> </div> </div>
             <div id="image-viewer-modal" class="modal-overlay hidden" onclick="this.classList.add('hidden')"> <div class="modal-content" onclick="event.stopPropagation()"> <button id="image-viewer-close" onclick="document.getElementById('image-viewer-modal').classList.add('hidden')"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> </button> <img id="image-viewer-img" src="" alt="عرض الوصل" /> </div> </div>

             <!-- Import/Export Debts Modal -->
             <div id="import-export-modal" class="modal-overlay hidden">
                 <div class="modal-content max-w-lg w-full">
                     <div class="flex justify-between items-center mb-4">
                         <h3 class="text-lg font-bold" data-translate="importExportDebts">استيراد وتصدير الديون</h3>
                         <button id="close-import-export" class="cancel-button px-3 py-1 rounded">
                             <span data-translate="close">إغلاق</span>
                         </button>
                     </div>

                     <!-- Tabs -->
                     <div class="flex space-x-2 space-x-reverse mb-4">
                         <button id="tab-import" class="confirm-button px-4 py-2 rounded flex-1" data-translate="importDebtsFiles">استيراد ملفات ديون</button>
                         <button id="tab-export" class="cancel-button px-4 py-2 rounded flex-1" data-translate="exportDebtsFiles">تصدير ملفات ديون</button>
                     </div>

                     
                     <!-- Storage Info -->
                     <div id="storage-info-box" class="border rounded p-3 mb-4 bg-gray-100">
                         <div class="flex justify-between items-center mb-2">
                             <div class="font-bold text-sm" data-translate="storageInfo">معلومات التخزين</div>
                             <button id="request-persistent" class="cancel-button px-3 py-1 rounded text-sm" data-translate="requestPersistent">تثبيت التخزين</button>
                         </div>
                         <div id="storage-info" class="text-sm text-secondary">...</div>
                         <div id="persistent-result" class="mt-2 text-sm"></div>
                     </div>
<!-- Import View -->
                     <div id="import-view">
                         <p class="text-sm text-secondary mb-3" data-translate="importHint">اختر ملف/ملفات ديون تم تصديرها سابقاً (JSON) لاستيرادها.</p>
                         <input id="import-files-input" type="file" accept="application/json,.json" multiple class="w-full mb-3" />
                         <div class="flex justify-end space-x-2 space-x-reverse">
                             <button id="do-import" class="confirm-button px-4 py-2 rounded" data-translate="import">استيراد</button>
                         </div>
                         <div id="import-result" class="mt-3 text-sm"></div>
                     </div>

                     <!-- Export View -->
                     <div id="export-view" class="hidden">
                         <p class="text-sm text-secondary mb-3" data-translate="exportHint">حدد أسماء الأشخاص لتصدير ديونهم (سيتم إنشاء ملف لكل اسم).</p>
                         <div id="export-persons-list" class="max-h-64 overflow-y-auto border rounded p-2 mb-3"></div>
                         <div class="flex justify-between items-center mb-3">
                             <button id="select-all-export" class="cancel-button px-3 py-1 rounded" data-translate="selectAll">تحديد الكل</button>
                             <button id="clear-all-export" class="cancel-button px-3 py-1 rounded" data-translate="clearAll">مسح التحديد</button>
                         </div>
                         <div class="flex justify-end space-x-2 space-x-reverse">
                             <button id="do-export" class="confirm-button px-4 py-2 rounded" data-translate="export">تصدير</button>
                         </div>
                         <div id="export-result" class="mt-4 space-y-2"></div>
                     </div>
                 </div>
             </div>

             <div id="about-modal" class="modal-overlay hidden"> <div class="modal-content max-w-lg w-full"> <div class="flex justify-between items-center mb-4"> <h3 data-translate="aboutApp">لمحة عن التطبيق</h3> <button onclick="document.getElementById('about-modal').classList.add('hidden')"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> </button> </div> <p><strong data-translate="appName">تطبيق (بسيط لتدوين الديون)</strong> <span data-translate="aboutText1">هو رفيقك المثالي لتتبع وإدارة الديون الشخصية بكل سهولة ويسر.</span></p> <p data-translate="aboutText2">نؤمن في هذا التطبيق بأن التكنولوجيا يجب أن تبسط حياتنا، لا أن تعقدها. لذلك، صممنا هذه الأداة بواجهة   بسيطة ومرنة، مع التركيز على الوظائف الأساسية التي تحتاجها لإدارة ديونك بفعالية، دون الإغراق في تفاصيل غير ضرورية.</p> <p data-translate="aboutText3">هدفنا هو تقديم تجربة مريحة ومباشرة، تتيح للجميع، بغض النظر عن خبرتهم التقنية، تسجيل ومتابعة التزاماتهم المالية الشخصية بثقة ووضوح. نتطلع دائمًا لتحسين التطبيق بناءً على ملاحظاتكم لنجعله الأداة الأبسط والأكثر فعالية لإدارة الديون.</p> </div> </div>
        </div>
    </div>

    <!-- Main Application Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- IndexedDB KV Storage ---
            // سبب الإضافة: localStorage محدود (~5MB) ويسبب فقدان البيانات إذا فشل الحفظ.
            const KV_DB_NAME = 'DebtTrackerDB';
            const KV_DB_VERSION = 1;
            const KV_STORE = 'kv';

            function kvOpen() {
                return new Promise((resolve, reject) => {
                    if (!('indexedDB' in window)) return reject(new Error('IndexedDB not supported'));
                    const req = indexedDB.open(KV_DB_NAME, KV_DB_VERSION);
                    req.onupgradeneeded = () => {
                        const db = req.result;
                        if (!db.objectStoreNames.contains(KV_STORE)) {
                            db.createObjectStore(KV_STORE, { keyPath: 'k' });
                        }
                    };
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error || new Error('Failed to open IndexedDB'));
                });
            }

            async function kvGet(key) {
                const db = await kvOpen();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(KV_STORE, 'readonly');
                    const store = tx.objectStore(KV_STORE);
                    const req = store.get(key);
                    req.onsuccess = () => resolve(req.result ? req.result.v : null);
                    req.onerror = () => reject(req.error || new Error('kvGet failed'));
                });
            }

            async function kvSet(key, value) {
                const db = await kvOpen();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(KV_STORE, 'readwrite');
                    const store = tx.objectStore(KV_STORE);
                    store.put({ k: key, v: value });
                    tx.oncomplete = () => resolve(true);
                    tx.onerror = () => reject(tx.error || new Error('kvSet failed'));
                });
            }

            async function kvDel(key) {
                const db = await kvOpen();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(KV_STORE, 'readwrite');
                    const store = tx.objectStore(KV_STORE);
                    store.delete(key);
                    tx.oncomplete = () => resolve(true);
                    tx.onerror = () => reject(tx.error || new Error('kvDel failed'));
                });
            }

            async function loadPersonsFromStorage() {
                // 1) جرّب IndexedDB
                try {
                    const v = await kvGet('debtTrackerPersons');
                    if (Array.isArray(v)) return v;
                } catch (e) {
                    // تجاهل وجرّب fallback
                }

                // 2) fallback: localStorage (للمستخدمين القدامى)
                try {
                    const raw = localStorage.getItem('debtTrackerPersons');
                    const parsed = raw ? JSON.parse(raw) : [];
                    if (Array.isArray(parsed)) {
                        // حاول ننقلها إلى IndexedDB حتى ننهي مشكلة الـ quota
                        try { await kvSet('debtTrackerPersons', parsed); localStorage.removeItem('debtTrackerPersons'); } catch(_) {}
                        return parsed;
                    }
                } catch (_) {}

                return [];
            }

            async function savePersonsToStorage(personsValue) {
                // نخزن الديون/الأشخاص في IndexedDB فقط.
                // ملاحظة: localStorage محدود (~5MB) ويسبب رسالة Quota حتى لو كان الحفظ في IndexedDB ناجح.
                try {
                    await kvSet('debtTrackerPersons', personsValue);
                } catch (e) {
                    console.error('Failed to persist persons in IndexedDB', e);
                    // نبقي البيانات بالذاكرة، لكن ننبه المستخدم أن الحفظ فشل.
                    alert((translateText('importFailed') || 'تعذر الحفظ') + ': ' + (e?.message || e));
                }
            }

            // --- State Variables ---
            let persons = []; // سيتم تحميلها من IndexedDB/LocalStorage أثناء التهيئة
            let currentPerson = null; let selectedDebt = null; let editingDebt = null; let editingPersonId = null;
            let currentLang = localStorage.getItem('debtTrackerLang') || 'ar';
            let currentCurrency = localStorage.getItem('debtTrackerCurrency') || 'ل.س';
            let isDarkMode = localStorage.getItem('debtTrackerDarkMode') === 'true';
            let confirmationCallback = null;

            // --- DOM Elements ---
            const htmlElement = document.documentElement; const appHeader = document.getElementById('app-header'); const headerTitle = document.getElementById('header-title'); const closePersonViewButton = document.getElementById('close-person-view'); const personListView = document.getElementById('person-list-view'); const personsContainer = document.getElementById('persons-container'); const addPersonForm = document.getElementById('add-person-form'); const newPersonNameInput = document.getElementById('new-person-name-input'); const cancelAddPersonButton = document.getElementById('cancel-add-person'); const confirmAddPersonButton = document.getElementById('confirm-add-person'); const showAddPersonButton = document.getElementById('show-add-person-button'); const totalSummaryDiv = document.getElementById('total-summary'); const totalDebtAmountSpan = document.getElementById('total-debt-amount'); const totalDebtStatusDiv = document.getElementById('total-debt-status'); const personDetailView = document.getElementById('person-detail-view'); const debtsContainer = document.getElementById('debts-container'); const addDebtForm = document.getElementById('add-debt-form'); const newDebtAmountInput = document.getElementById('new-debt-amount'); const newDebtNoteInput = document.getElementById('new-debt-note'); const newDebtReceiptPreviewContainer = document.getElementById('new-debt-receipt-preview-container'); const newDebtReceiptInput = document.getElementById('new-debt-receipt-input'); const newDebtOwedByMeLabel = document.getElementById('new-debt-owed-by-me-label'); const cancelAddDebtButton = document.getElementById('cancel-add-debt'); const confirmAddDebtButton = document.getElementById('confirm-add-debt'); const showAddDebtButton = document.getElementById('show-add-debt-button'); const personSummaryDiv = document.getElementById('person-summary');
            const editDebtModal = document.getElementById('edit-debt-modal'); const editDebtIdInput = document.getElementById('edit-debt-id'); const editDebtAmountInput = document.getElementById('edit-debt-amount'); const editDebtNoteInput = document.getElementById('edit-debt-note'); const editDebtReceiptPreviewContainer = document.getElementById('edit-debt-receipt-preview-container'); const editDebtReceiptInput = document.getElementById('edit-debt-receipt-input'); const editDebtOwedByMeLabel = document.getElementById('edit-debt-owed-by-me-label'); const cancelEditDebtButton = document.getElementById('cancel-edit-debt'); const confirmUpdateDebtButton = document.getElementById('confirm-update-debt'); const deleteDebtFromEditButton = document.getElementById('delete-debt-from-edit');
            const editPersonModal = document.getElementById('edit-person-modal'); const editPersonIdInput = document.getElementById('edit-person-id'); const editPersonNameInput = document.getElementById('edit-person-name-input'); const cancelEditPersonButton = document.getElementById('cancel-edit-person'); const confirmUpdatePersonButton = document.getElementById('confirm-update-person');
            const printButtonDetails = document.getElementById('print-button-details'); const imageViewerModal = document.getElementById('image-viewer-modal'); const imageViewerImg = document.getElementById('image-viewer-img'); const menuButton = document.getElementById('menu-button'); const sidebar = document.getElementById('sidebar'); const sidebarOverlay = document.getElementById('sidebar-overlay'); const darkModeToggle = document.getElementById('dark-mode-toggle'); const currencySelect = document.getElementById('currency-select'); const languageSelect = document.getElementById('language-select'); const showAboutButton = document.getElementById('show-about-button'); const aboutModal = document.getElementById('about-modal');
            const confirmationModal = document.getElementById('confirmation-modal'); const confirmationMessage = document.getElementById('confirmation-message'); const confirmActionBtn = document.getElementById('confirm-action-btn'); const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn'); const debtOptionsModal = document.getElementById('debt-options-modal'); const debtOptionsList = document.getElementById('debt-options-list'); const cancelDebtOptionsBtn = document.getElementById('cancel-debt-options');
            const importExportModal = document.getElementById('import-export-modal');
            const openImportExportBtn = document.getElementById('open-import-export');
            const closeImportExportBtn = document.getElementById('close-import-export');
            const requestPersistentBtn = document.getElementById('request-persistent');
            const tabImportBtn = document.getElementById('tab-import');
            const tabExportBtn = document.getElementById('tab-export');
            const importView = document.getElementById('import-view');
            const exportView = document.getElementById('export-view');
            const importFilesInput = document.getElementById('import-files-input');
            const doImportBtn = document.getElementById('do-import');
            const importResult = document.getElementById('import-result');
            const exportPersonsList = document.getElementById('export-persons-list');
            const selectAllExportBtn = document.getElementById('select-all-export');
            const clearAllExportBtn = document.getElementById('clear-all-export');
            const doExportBtn = document.getElementById('do-export');
            const exportResult = document.getElementById('export-result');


            // --- Icons SVG ---
            const icons = { camera: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-secondary mb-1"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>`, edit2: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`, checkSquare: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>`, plus: `<svg class="ml-1" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`, arrowRight: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>`, x: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`, pdf: `<svg class="ml-1" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`, trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>` };

             // --- Translations Object ---
             const translations = { ar: { appTitle: "بسيط لتدوين الديون", settings: "الإعدادات", darkMode: "الوضع الداكن", currency: "العملة", language: "اللغة", aboutApp: "لمحة عن التطبيق", addNewPerson: "إضافة شخص جديد", totalBalance: "المجموع الكلي:", noDebts: "لا توجد ديون", debtsForMe: "ديون لصالحي", debtsOnMe: "ديون علي", addNewDebt: "إضافة دين جديد", amount: "المبلغ", note: "ملاحظة", receipt: "وصل الدين", debtForMe: "دين لصالحي", debtForPerson: "دين لصالح {name}", printStatement: "طباعة كشف الحساب", personNamePlaceholder: "اسم الشخص", cancel: "إلغاء", add: "إضافة", saveChanges: "حفظ التغييرات", enterAmountPlaceholder: "أدخل المبلغ", addNotePlaceholder: "أضف ملاحظة (اختياري)", editDebt: "تعديل الدين", deleteDebt: "حذف الدين", editPersonName: "تعديل اسم الشخص", name: "الاسم", confirmation: "تأكيد", confirmationTitle: "تأكيد الإجراء", confirmDebtChange: "هل أنت متأكد من تغيير حالة الدين؟", confirmDeleteDebtMessage: "هل أنت متأكد من حذف هذا الدين؟", confirm: "تأكيد", personDebtSummary: "دين لصالحي:", personOwesYou: "{name} مدين لك", youOwePerson: "أنت مدين لـ {name}", netBalance: "الصافي:", noNetDebt: "لا يوجد دين", debtPaid: "تم الدفع", debtUnpaidForMe: "دين لصالحي", debtUnpaidForPerson: "دين لصالح {name}", noNotes: "لا توجد ملاحظات", debtForPersonTitle: "دين لصالح {name}:", edit: "تعديل", markPaid: "تم الدفع", markUnpaid: "إلغاء الدفع", delete: "حذف", appName: "تطبيق (بسيط لتدوين الديون)", aboutText1: "هو رفيقك المثالي لتتبع وإدارة الديون الشخصية بكل سهولة ويسر.", aboutText2: "نؤمن في هذا التطبيق بأن التكنولوجيا يجب أن تبسط حياتنا، لا أن تعقدها. لذلك، صممنا هذه الأداة بواجهة   بسيطة ومرنة، مع التركيز على الوظائف الأساسية التي تحتاجها لإدارة ديونك بفعالية، دون الإغراق في تفاصيل غير ضرورية.", aboutText3: "هدفنا هو تقديم تجربة مريحة ومباشرة، تتيح للجميع، بغض النظر عن خبرتهم التقنية، تسجيل ومتابعة التزاماتهم المالية الشخصية بثقة ووضوح. نتطلع دائمًا لتحسين التطبيق بناءً على ملاحظاتكم لنجعله الأداة الأبسط والأكثر فعالية لإدارة الديون.", noPersons: "لا يوجد أشخاص مسجلون.", noDebtsRecorded: "لا توجد ديون مسجلة حالياً", confirmDeletePerson: "هل أنت متأكد من حذف {name}؟ سيتم حذف جميع ديونه المسجلة معه نهائياً.", selectPersonToPrint: "يرجى تحديد شخص لعرض تفاصيله أولاً.", clickToAddImage: "اضغط لإضافة صورة", debtOptionsTitle: "خيارات الدين", importExportDebts: "استيراد وتصدير الديون", importDebtsFiles: "استيراد ملفات ديون", exportDebtsFiles: "تصدير ملفات ديون", importHint: "اختر ملف/ملفات ديون تم تصديرها سابقاً (JSON) لاستيرادها.", exportHint: "حدد أسماء الأشخاص لتصدير ديونهم (سيتم إنشاء ملف لكل اسم).", selectAll: "تحديد الكل", clearAll: "مسح التحديد", close: "إغلاق", import: "استيراد", export: "تصدير", nothingSelected: "ما محدد أي اسم.", importDone: "تم الاستيراد بنجاح.", importFailed: "تعذر الاستيراد: ", exportReady: "الملفات جاهزة للتنزيل:", download: "تنزيل", share: "مشاركة" , receiptAlt: "وصل", storageInfo: "معلومات التخزين", requestPersistent: "تثبيت التخزين", storageUnsupported: "المتصفح لا يدعم قراءة مساحة التخزين.", persistentUnsupported: "المتصفح لا يدعم تثبيت التخزين.", persistentGranted: "تم تثبيت التخزين (احتمال الحذف صار أقل).", persistentDenied: "ما تم تثبيت التخزين (المتصفح/النظام رفض).", storageUsed: "المستخدم", storageQuota: "المتاح"}, en: { appTitle: "Debt Tracker App", settings: "Settings", darkMode: "Dark Mode", currency: "Currency", language: "Language", aboutApp: "About App", addNewPerson: "Add New Person", totalBalance: "Total Balance:", noDebts: "No debts", debtsForMe: "Debts owed to me", debtsOnMe: "Debts owed by me", addNewDebt: "Add New Debt", amount: "Amount", note: "Note", receipt: "Receipt", debtForMe: "Owed to me", debtForPerson: "Owed to {name}", printStatement: "Print Statement", personNamePlaceholder: "Person's name", cancel: "Cancel", add: "Add", saveChanges: "Save Changes", enterAmountPlaceholder: "Enter amount", addNotePlaceholder: "Add a note (optional)", editDebt: "Edit Debt", deleteDebt: "Delete Debt", editPersonName: "Edit Person Name", name: "Name", confirmation: "Confirmation", confirmationTitle: "Confirm Action", confirmDebtChange: "Are you sure you want to change the debt status?", confirmDeleteDebtMessage: "Are you sure you want to delete this debt?", confirm: "Confirm", personDebtSummary: "Owed to me:", personOwesYou: "{name} owes you", youOwePerson: "You owe {name}", netBalance: "Net:", noNetDebt: "Settled up", debtPaid: "Paid", debtUnpaidForMe: "Owed to me", debtUnpaidForPerson: "Owed to {name}", noNotes: "No notes", debtForPersonTitle: "Owed to {name}:", edit: "Edit", markPaid: "Mark as Paid", markUnpaid: "Mark as Unpaid", delete: "Delete", appName: "Simple Debt Tracker", aboutText1: "is your ideal companion for tracking and managing personal debts with ease.", aboutText2: "We believe technology should simplify our lives, not complicate them. That's why we designed this tool with an intuitive and flexible interface, focusing on the essential functions you need to manage your debts effectively, without unnecessary clutter.", aboutText3: "Our goal is to provide a comfortable and straightforward experience, allowing everyone, regardless of technical expertise, to record and track their personal financial obligations with confidence and clarity. We always look forward to improving the app based on your feedback to make it the simplest and most effective debt management tool.", noPersons: "No persons recorded.", noDebtsRecorded: "No debts recorded currently.", confirmDeletePerson: "Are you sure you want to delete {name}? All associated debts will be permanently removed.", selectPersonToPrint: "Please select a person to view details first.", clickToAddImage:"Click to add image", debtOptionsTitle: "Debt Options", importExportDebts: "Import & Export Debts", importDebtsFiles: "Import debt files", exportDebtsFiles: "Export debt files", importHint: "Choose one or more previously exported debt JSON files to import.", exportHint: "Select people to export (one file per person).", selectAll: "Select all", clearAll: "Clear selection", close: "Close", import: "Import", export: "Export", nothingSelected: "No names selected.", importDone: "Import completed.", importFailed: "Import failed: ", exportReady: "Files ready to download:", download: "Download", share: "Share", receiptAlt: "Receipt", storageInfo: "Storage info", requestPersistent: "Make storage persistent", storageUnsupported: "Your browser doesn't support storage estimation.", persistentUnsupported: "Your browser doesn't support persistent storage request.", persistentGranted: "Storage is now persistent (less likely to be cleared).", persistentDenied: "Persistent storage was not granted.", storageUsed: "Used", storageQuota: "Available"}, de: { appTitle: "Schulden Tracker App", settings: "Einstellungen", darkMode: "Dunkelmodus", currency: "Währung", language: "Sprache", aboutApp: "Über die App", addNewPerson: "Neue Person hinzufügen", totalBalance: "Gesamtsaldo:", noDebts: "Keine Schulden", debtsForMe: "Mir geschuldete Beträge", debtsOnMe: "Von mir geschuldete Beträge", addNewDebt: "Neue Schuld hinzufügen", amount: "Betrag", note: "Notiz", receipt: "Beleg", debtForMe: "Mir geschuldet", debtForPerson: "{name} geschuldet", printStatement: "Kontoauszug drucken", personNamePlaceholder: "Name der Person", cancel: "Abbrechen", add: "Hinzufügen", saveChanges: "Änderungen speichern", enterAmountPlaceholder: "Betrag eingeben", addNotePlaceholder: "Notiz hinzufügen (optional)", editDebt: "Schuld bearbeiten", deleteDebt: "Schuld löschen", editPersonName: "Personennamen bearbeiten", name: "Name", confirmation: "Bestätigung", confirmationTitle: "Aktion bestätigen", confirmDebtChange: "Sind Sie sicher, dass Sie den Schuldenstatus ändern möchten?", confirmDeleteDebtMessage: "Sind Sie sicher, dass Sie diese Schuld löschen möchten?", confirm: "Bestätigen", personDebtSummary: "Mir geschuldet:", personOwesYou: "{name} schuldet Ihnen", youOwePerson: "Sie schulden {name}", netBalance: "Netto:", noNetDebt: "Ausgeglichen", debtPaid: "Bezahlt", debtUnpaidForMe: "Mir geschuldet", debtUnpaidForPerson: "{name} geschuldet", noNotes: "Keine Notizen", debtForPersonTitle: "{name} geschuldet:", edit: "Bearbeiten", markPaid: "Als bezahlt markieren", markUnpaid: "Als unbezahlt markieren", delete: "Löschen", appName: "Einfacher Schulden Tracker", aboutText1: "ist Ihr idealer Begleiter, um persönliche Schulden einfach und mühelos zu verfolgen und zu verwalten.", aboutText2: "Wir glauben, dass Technologie unser Leben vereinfachen und nicht verkomplizieren sollte. Deshalb haben wir dieses Tool mit einer intuitiven und flexiblen Benutzeroberfläche entwickelt, die sich auf die wesentlichen Funktionen konzentriert, die Sie zur effektiven Verwaltung Ihrer Schulden benötigen, ohne unnötigen Ballast.", aboutText3: "Unser Ziel ist es, eine komfortable und unkomplizierte Erfahrung zu bieten, die es jedem, unabhängig von technischen Kenntnissen, ermöglicht, seine persönlichen finanziellen Verpflichtungen sicher und klar zu erfassen und zu verfolgen. Wir freuen uns immer darauf, die App basierend auf Ihrem Feedback zu verbessern, um sie zum einfachsten und effektivsten Werkzeug für die Schuldenverwaltung zu machen.", noPersons: "Keine Personen erfasst.", noDebtsRecorded: "Derzeit keine Schulden erfasst.", confirmDeletePerson: "Sind Sie sicher, dass Sie {name} löschen möchten? Alle zugehörigen Schulden werden dauerhaft entfernt.", selectPersonToPrint: "Bitte wählen Sie zuerst eine Person aus, um Details anzuzeigen.", clickToAddImage:"Klicken Sie, um Bild hinzuzufügen", debtOptionsTitle: "Schuldenoptionen", importExportDebts: "Schulden importieren & exportieren", importDebtsFiles: "Schulden-Dateien importieren", exportDebtsFiles: "Schulden-Dateien exportieren", importHint: "Wähle eine oder mehrere zuvor exportierte JSON-Dateien zum Import.", exportHint: "Personen auswählen (eine Datei pro Person).", selectAll: "Alle auswählen", clearAll: "Auswahl löschen", close: "Schließen", import: "Importieren", export: "Exportieren", nothingSelected: "Keine Namen ausgewählt.", importDone: "Import abgeschlossen.", importFailed: "Import fehlgeschlagen: ", exportReady: "Dateien zum Download bereit:", download: "Download", share: "Teilen", receiptAlt: "Beleg", storageInfo: "Speicherinfo", requestPersistent: "Speicher dauerhaft machen", storageUnsupported: "Ihr Browser unterstützt keine Speicherabschätzung.", persistentUnsupported: "Ihr Browser unterstützt keine dauerhafte Speicherung.", persistentGranted: "Speicher ist jetzt dauerhaft (weniger wahrscheinlich gelöscht).", persistentDenied: "Dauerhafte Speicherung wurde nicht gewährt.", storageUsed: "Belegt", storageQuota: "Verfügbar"} };

            // --- State Management & Settings ---
            const saveState = () => { savePersonsToStorage(persons); };
            const saveSettings = () => { localStorage.setItem('debtTrackerLang', currentLang); localStorage.setItem('debtTrackerCurrency', currentCurrency); localStorage.setItem('debtTrackerDarkMode', isDarkMode); }

            // --- Storage (IndexedDB-like quota display for local storage usage) ---
            function formatBytes(bytes) {
                const b = Number(bytes) || 0;
                const units = ['B','KB','MB','GB','TB'];
                let v = b, u = 0;
                while (v >= 1024 && u < units.length-1) { v /= 1024; u++; }
                return `${v.toFixed(v >= 10 || u===0 ? 0 : 1)} ${units[u]}`;
            }

            async function updateStorageInfoUI() {
                const infoEl = document.getElementById('storage-info');
                if (!infoEl) return;
                if (!navigator.storage || !navigator.storage.estimate) {
                    infoEl.textContent = translateText('storageUnsupported');
                    return;
                }
                try {
                    const est = await navigator.storage.estimate();
                    const quota = est.quota || 0;
                    const usage = est.usage || 0;
                    const pct = quota ? Math.min(100, Math.round((usage / quota) * 100)) : 0;
                    const usedTxt = `${translateText('storageUsed')}: ${formatBytes(usage)}`;
                    const quotaTxt = `${translateText('storageQuota')}: ${formatBytes(quota)}`;
                    infoEl.innerHTML = `<div class="flex justify-between"><span>${usedTxt}</span><span>${quotaTxt}</span></div>
                                        <div class="mt-2 w-full bg-gray-200 rounded h-2 overflow-hidden">
                                            <div style="width:${pct}%" class="bg-indigo-600 h-2"></div>
                                        </div>
                                        <div class="mt-1 text-xs text-secondary">${pct}%</div>`;
                } catch (e) {
                    infoEl.textContent = translateText('storageUnsupported');
                }
            }

            async function requestPersistentStorage() {
                const resEl = document.getElementById('persistent-result');
                if (!resEl) return;
                resEl.textContent = '';
                if (!navigator.storage || !navigator.storage.persist) {
                    resEl.textContent = translateText('persistentUnsupported');
                    return;
                }
                try {
                    const granted = await navigator.storage.persist();
                    resEl.textContent = granted ? translateText('persistentGranted') : translateText('persistentDenied');
                } catch (e) {
                    resEl.textContent = translateText('persistentDenied');
                }
            }
            function applyTranslations() { const langData = translations[currentLang] || translations.ar; document.querySelectorAll('[data-translate]').forEach(el => { const key = el.getAttribute('data-translate'); if (langData[key]) { let text = langData[key]; if (el.dataset.translateName && currentPerson) { text = text.replace('{name}', currentPerson.name); } else if (el.dataset.translateName) { text = text.replace('{name}', '...'); } el.textContent = text; } }); document.querySelectorAll('[data-translate-placeholder]').forEach(el => { const key = el.getAttribute('data-translate-placeholder'); if (langData[key]) { el.placeholder = langData[key]; } }); htmlElement.lang = currentLang; htmlElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr'; }
            function toggleDarkMode(forceDark) { isDarkMode = typeof forceDark === 'boolean' ? forceDark : !isDarkMode; htmlElement.classList.toggle('dark', isDarkMode); darkModeToggle.checked = isDarkMode; saveSettings(); updateAndRender(); /* Needs re-render for background classes */ }
            function setCurrency(currency) { currentCurrency = currency; currencySelect.value = currency; saveSettings(); updateAndRender(); }
            function setLanguage(lang) { currentLang = lang; languageSelect.value = lang; saveSettings(); updateAndRender(); }
            function toggleSidebar(open) { const active = typeof open === 'boolean' ? open : !sidebar.classList.contains('active'); sidebar.classList.toggle('active', active); sidebarOverlay.classList.toggle('active', active); }

            // --- Calculations & Rendering ---
            const calculatePersonDebt = (person) => { let tOwedToMe = 0, tOwedByMe = 0; if (person?.debts) { person.debts.forEach(d => { if (!d.isPaid) { const a = parseFloat(d.amount) || 0; if (d.isOwedToMe) tOwedToMe += a; else tOwedByMe += a; } }); } return { totalOwedToMe: tOwedToMe, totalOwedByMe: tOwedByMe }; };
            const calculateTotalDebt = () => { let t = 0; persons.forEach(p => { if(p?.debts) { p.debts.forEach(d => { if (!d.isPaid) { const a = parseFloat(d.amount) || 0; if (d.isOwedToMe) t += a; else t -= a; } }); } }); return t; };
            // --- UPDATED formatCurrency for standard numbers ---
            const formatCurrency = (amount) => { return `${Math.abs(amount).toLocaleString('en-US')} ${currentCurrency}`; } // Use en-US locale for 1,234 format
            const translateText = (key, replacements = {}) => { const langData = translations[currentLang] || translations.ar; let text = langData[key] || `[${key}]`; for (const p in replacements) { text = text.replace(`{${p}}`, replacements[p]); } return text; }
            const renderReceiptArea = (container, receiptData, inputId) => { container.innerHTML = ''; if (receiptData) { const w = document.createElement('div'); w.className = 'relative w-full'; const i = document.createElement('img'); i.src = receiptData; i.alt = 'وصل'; i.className = 'w-full h-32 object-contain'; w.appendChild(i); const rB = document.createElement('button'); rB.innerHTML = icons.x; rB.className = 'absolute top-0 left-0 bg-red-500 text-white rounded-full p-1 m-1'; rB.onclick = (e) => { e.stopPropagation(); if (container.id.includes('edit')) { if(editingDebt) editingDebt.receipt = null; renderReceiptArea(editDebtReceiptPreviewContainer, null, 'edit-debt-receipt-input'); } else { document.getElementById(inputId).value = ''; renderReceiptArea(newDebtReceiptPreviewContainer, null, 'new-debt-receipt-input'); } }; w.appendChild(rB); container.appendChild(w); } else { const l = document.createElement('label'); l.htmlFor = inputId; l.className = 'file-input-label'; l.innerHTML = `${icons.camera}<span class="text-sm text-secondary">${translateText('clickToAddImage')}</span>`; container.appendChild(l); } };

            const renderDebtItem = (debt) => {
                let specificBgClass = debt.isPaid ? "debt-item-paid" : (debt.isOwedToMe ? "debt-item-positive" : "debt-item-negative");
                let finalBgClass = isDarkMode ? "debt-item-base" : specificBgClass;
                const debtDiv = document.createElement('div'); debtDiv.className = `p-3 rounded-lg shadow border relative ${finalBgClass}`; debtDiv.dataset.debtId = debt.id;
                let statusText = debt.isPaid ? translateText('debtPaid') : (debt.isOwedToMe ? translateText('debtUnpaidForMe') : translateText('debtUnpaidForPerson', {name: currentPerson.name}));
                let statusColorClass = debt.isPaid ? 'text-status-paid' : (debt.isOwedToMe ? 'text-status-positive' : 'text-status-negative');
                const imageContainerClass = debt.receipt ? 'receipt-image-container w-40 h-40 mr-3 overflow-hidden rounded border ml-3 flex-shrink-0' : ''; const imageClickListener = debt.receipt ? `onclick="showImage('${debt.receipt}')"` : ''; const receiptImageHTML = debt.receipt ? `<div class="${imageContainerClass}" ${imageClickListener}><img src="${debt.receipt}" alt="${translateText('receiptAlt', 'وصل')}" class="w-full h-full object-contain"></div>` : '';
               debtDiv.innerHTML = `<div class="flex justify-between items-start"><div class="flex-1 min-w-0"><div class="flex justify-between"><span class="font-bold text-lg">${formatCurrency(parseFloat(debt.amount || 0))}</span><span class="text-sm text-secondary">${debt.date || ''}</span></div><p class="mt-1 break-words">${debt.note || translateText('noNotes')}</p><div class="text-sm mt-2"><span class="${statusColorClass}">${statusText}</span></div></div>${receiptImageHTML}</div><div class="absolute bottom-3 left-3 flex space-x-1 space-x-reverse"><button class="options-toggle bg-gray-200 text-gray-700 p-1 rounded">${icons.edit2}</button></div>`; // Removed inline popup
                debtDiv.querySelector('.options-toggle').addEventListener('click', (e) => { e.stopPropagation(); openDebtOptionsModal(debt.id); });
                return debtDiv;
            };

            const renderPersonList = () => { /* ... (same as before) ... */ personsContainer.innerHTML = ''; if (persons.length === 0) { personsContainer.innerHTML = `<div class="text-center py-8 text-secondary">${translateText('noPersons')}</div>`; } else { persons.forEach(person => { const { totalOwedToMe, totalOwedByMe } = calculatePersonDebt(person); const netDebt = totalOwedToMe - totalOwedByMe; let specificBgClass = "debt-item-neutral", debtStatusText = translateText('noNetDebt'), amountColorClass = 'text-status-neutral'; if (netDebt > 0) { specificBgClass = "debt-item-positive"; debtStatusText = translateText('debtsForMe'); amountColorClass = 'text-status-positive'; } else if (netDebt < 0) { specificBgClass = "debt-item-negative"; debtStatusText = translateText('debtForPerson', {name: person.name}); amountColorClass = 'text-status-negative'; } let finalBgClass = isDarkMode ? "debt-item-base" : specificBgClass; const personDiv = document.createElement('div'); personDiv.className = `p-3 rounded-lg shadow border person-card ${finalBgClass}`; personDiv.dataset.personId = person.id; const contentDiv = document.createElement('div'); contentDiv.innerHTML = `<div class="flex justify-between items-center"><h3 class="font-bold text-lg">${person.name}</h3><span class="font-bold ${amountColorClass}">${formatCurrency(netDebt)}</span></div><div class="text-sm text-secondary mt-1">${debtStatusText}</div>`; contentDiv.addEventListener('click', () => viewPerson(person.id)); personDiv.appendChild(contentDiv); const optionsContainer = document.createElement('div'); optionsContainer.className = 'absolute bottom-3 left-3 flex space-x-1 space-x-reverse'; optionsContainer.innerHTML = `<button class="options-toggle bg-gray-200 text-gray-700 p-1 rounded">${icons.edit2}</button><div class="options-popup hidden"><button class="edit-person-button block w-full text-right px-4 py-2 hover:bg-secondary text-sm flex items-center justify-end">${icons.edit2} <span class="mr-1">${translateText('edit')}</span></button><button class="delete-person-button block w-full text-right px-4 py-2 hover:bg-secondary text-sm text-status-negative flex items-center justify-end">${icons.trash} <span class="mr-1">${translateText('delete')}</span></button></div>`; personDiv.appendChild(optionsContainer); optionsContainer.querySelector('.options-toggle').addEventListener('click', (e) => { e.stopPropagation(); toggleOptionsPopup(personDiv); }); optionsContainer.querySelector('.edit-person-button').addEventListener('click', (e) => { e.stopPropagation(); openEditPerson(person.id); }); optionsContainer.querySelector('.delete-person-button').addEventListener('click', (e) => { e.stopPropagation(); deletePerson(person.id); }); personsContainer.appendChild(personDiv); }); } const total = calculateTotalDebt(); totalDebtAmountSpan.textContent = formatCurrency(total); let totalStatusKey = 'noDebts'; let totalColorClass = 'text-status-neutral'; if (total > 0) { totalStatusKey = 'debtsForMe'; totalColorClass = 'text-status-positive'; } else if (total < 0) { totalStatusKey = 'debtsOnMe'; totalColorClass = 'text-status-negative'; } totalDebtAmountSpan.className = `font-bold text-lg ${totalColorClass}`; totalDebtStatusDiv.dataset.translate = totalStatusKey; personListView.classList.remove('hidden'); personDetailView.classList.add('hidden'); headerTitle.dataset.translate = 'appTitle'; closePersonViewButton.classList.add('hidden'); addPersonForm.classList.add('hidden'); showAddPersonButton.classList.remove('hidden'); };
            const renderPersonDetails = () => { /* ... (same as before) ... */ if (!currentPerson) { renderPersonList(); return; } personDetailView.dataset.personName = currentPerson.name; debtsContainer.innerHTML = ''; if (!currentPerson.debts?.length) { debtsContainer.innerHTML = `<div class="text-center py-8 text-secondary">${translateText('noDebtsRecorded')}</div>`; } else { const sortedDebts = [...currentPerson.debts].sort((a, b) => (a.date ? new Date(a.date) : 0) - (b.date ? new Date(b.date) : 0)); sortedDebts.forEach(debt => debtsContainer.appendChild(renderDebtItem(debt))); } const { totalOwedToMe, totalOwedByMe } = calculatePersonDebt(currentPerson); const netDebt = totalOwedToMe - totalOwedByMe; let summaryHTML = ''; if (totalOwedToMe > 0) summaryHTML += `<div class="flex justify-between items-center"><h3 class="font-medium">${translateText('personDebtSummary')}</h3><span class="font-bold text-status-positive">${formatCurrency(totalOwedToMe)}</span></div>`; if (totalOwedByMe > 0) summaryHTML += `<div class="flex justify-between items-center"><h3 class="font-medium">${translateText('debtForPersonTitle', {name: currentPerson.name})}</h3><span class="font-bold text-status-negative">${formatCurrency(totalOwedByMe)}</span></div>`; let netAmountColorClass = 'text-status-neutral', netStatusText = translateText('noNetDebt'); if (netDebt > 0) { netAmountColorClass = 'text-status-positive'; netStatusText = translateText('personOwesYou', {name: currentPerson.name}); } else if (netDebt < 0) { netAmountColorClass = 'text-status-negative'; netStatusText = translateText('youOwePerson', {name: currentPerson.name}); } summaryHTML += `<div class="flex justify-between items-center pt-2 border-t mt-2"><h3 class="font-bold">${translateText('netBalance')}</h3><span class="font-bold text-lg ${netAmountColorClass}">${formatCurrency(netDebt)}</span></div><div class="text-sm text-secondary">${netStatusText}</div>`; personSummaryDiv.innerHTML = summaryHTML; headerTitle.textContent = `${currentPerson.name}`; headerTitle.removeAttribute('data-translate'); closePersonViewButton.classList.remove('hidden'); personListView.classList.add('hidden'); personDetailView.classList.remove('hidden'); addDebtForm.classList.add('hidden'); showAddDebtButton.classList.remove('hidden'); document.getElementById('new-debt-owed-by-me-label').dataset.translateName = currentPerson.name; document.getElementById('new-debt-owed-by-me-label').dataset.translate = 'debtForPerson'; if(document.getElementById('edit-debt-owed-by-me-label')) { document.getElementById('edit-debt-owed-by-me-label').dataset.translateName = currentPerson.name; document.getElementById('edit-debt-owed-by-me-label').dataset.translate = 'debtForPerson'; } };
            const updateAndRender = () => { if (currentPerson) currentPerson = persons.find(p => p.id === currentPerson.id) || null; saveState(); if (currentPerson) { renderPersonDetails(); } else { renderPersonList(); } applyTranslations(); hideAllOptionPopups(); /* Also hide debt options modal if open */ debtOptionsModal.classList.add('hidden'); };

            // --- Import / Export Debts ---
            const sanitizeFileName = (name) => (name || 'person').toString().trim().replace(/[\\\/:*?"<>|]+/g, '_').replace(/\s+/g, '_').slice(0, 60) || 'person';

            const setImportExportTab = (tab) => {
                const isImport = tab === 'import';
                importView.classList.toggle('hidden', !isImport);
                exportView.classList.toggle('hidden', isImport);
                tabImportBtn.classList.toggle('confirm-button', isImport);
                tabImportBtn.classList.toggle('cancel-button', !isImport);
                tabExportBtn.classList.toggle('confirm-button', !isImport);
                tabExportBtn.classList.toggle('cancel-button', isImport);
            };

            const refreshExportPersonsList = () => {
                exportPersonsList.innerHTML = '';
                if (!persons.length) {
                    exportPersonsList.innerHTML = `<div class="text-center py-4 text-secondary">${translateText('noPersons')}</div>`;
                    return;
                }
                persons.forEach(p => {
                    const row = document.createElement('label');
                    row.className = 'flex items-center justify-between p-2 rounded hover:bg-secondary cursor-pointer';
                    row.innerHTML = `
                        <span class="truncate">${p.name}</span>
                        <input type="checkbox" class="ml-2 export-person-checkbox" data-person-id="${p.id}">
                    `;
                    exportPersonsList.appendChild(row);
                });
            };

            const openImportExportModal = () => {
                toggleSidebar(false);
                importResult.textContent = '';
                exportResult.innerHTML = '';
                importFilesInput.value = '';
                refreshExportPersonsList();
                setImportExportTab('import');
                importExportModal.classList.remove('hidden');
                updateStorageInfoUI();
                applyTranslations();
            };

            const closeImportExportModal = () => {
                importExportModal.classList.add('hidden');
            };

            const buildExportPayloadForPerson = (person) => ({
                schema: "debt-tracker-person",
                version: 1,
                exportedAt: new Date().toISOString(),
                person: {
                    name: person.name,
                },
                debts: Array.isArray(person.debts) ? person.debts : [],
            });

            const exportSelectedPersons = () => {
                const checked = [...exportPersonsList.querySelectorAll('.export-person-checkbox:checked')];
                exportResult.innerHTML = '';
                if (!checked.length) {
                    exportResult.innerHTML = `<div class="text-status-negative">${translateText('nothingSelected')}</div>`;
                    return;
                }

                const files = [];
                checked.forEach(chk => {
                    const id = parseInt(chk.dataset.personId, 10);
                    const person = persons.find(p => p.id === id);
                    if (!person) return;

                    const payload = buildExportPayloadForPerson(person);
                    const json = JSON.stringify(payload, null, 2);
                    const fileName = `debts_${sanitizeFileName(person.name)}.json`;
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    files.push({ personName: person.name, fileName, blob, url });
                });

                const titleDiv = document.createElement('div');
                titleDiv.className = 'text-sm text-secondary';
                titleDiv.textContent = translateText('exportReady');
                exportResult.appendChild(titleDiv);

                files.forEach(f => {
                    const row = document.createElement('div');
                    row.className = 'flex items-center justify-between gap-2 border rounded p-2';
                    const left = document.createElement('div');
                    left.className = 'min-w-0';
                    left.innerHTML = `<div class="font-bold truncate">${f.personName}</div><div class="text-xs text-secondary">${f.fileName}</div>`;

                    const actions = document.createElement('div');
                    actions.className = 'flex items-center space-x-2 space-x-reverse';

                    const a = document.createElement('a');
                    a.href = f.url;
                    a.download = f.fileName;
                    a.className = 'confirm-button px-3 py-1 rounded text-sm';
                    a.textContent = translateText('download');

                    actions.appendChild(a);

                    const canShareFiles = !!(navigator.share && navigator.canShare && navigator.canShare({ files: [new File([f.blob], f.fileName, { type: 'application/json' })] }));
                    if (canShareFiles) {
                        const shareBtn = document.createElement('button');
                        shareBtn.className = 'cancel-button px-3 py-1 rounded text-sm';
                        shareBtn.textContent = translateText('share');
                        shareBtn.addEventListener('click', async () => {
                            try {
                                const file = new File([f.blob], f.fileName, { type: 'application/json' });
                                await navigator.share({ files: [file], title: f.fileName });
                            } catch (e) { /* user cancelled */ }
                        });
                        actions.appendChild(shareBtn);
                    }

                    row.appendChild(left);
                    row.appendChild(actions);
                    exportResult.appendChild(row);
                });
            };

            const mergeImportedPerson = (importedPersonName, importedDebts) => {
                const name = (importedPersonName || '').trim();
                if (!name) return { ok: false, reason: 'missing_name' };

                const normalizedDebts = (Array.isArray(importedDebts) ? importedDebts : []).map(d => ({
                    id: Date.now() + Math.floor(Math.random() * 1000000),
                    amount: d.amount ?? 0,
                    note: d.note ?? '',
                    receipt: d.receipt ?? null,
                    isOwedToMe: !!d.isOwedToMe,
                    isPaid: !!d.isPaid,
                    date: d.date || new Date().toISOString().split('T')[0],
                }));

                const existing = persons.find(p => p.name.trim().toLowerCase() === name.toLowerCase());
                if (existing) {
                    existing.debts = Array.isArray(existing.debts) ? existing.debts : [];
                    existing.debts.push(...normalizedDebts);
                } else {
                    persons.push({ id: Date.now() + Math.floor(Math.random() * 1000000), name, debts: normalizedDebts });
                }
                return { ok: true, addedDebts: normalizedDebts.length };
            };

            const importDebtsFiles = async () => {
                importResult.className = 'mt-3 text-sm';
                importResult.textContent = '';

                const files = [...(importFilesInput.files || [])];
                if (!files.length) {
                    importResult.className = 'mt-3 text-sm text-status-negative';
                    importResult.textContent = translateText('importFailed') + 'no_files';
                    return;
                }

                let totalFiles = 0;
                let totalDebts = 0;
                try {
                    for (const file of files) {
                        const text = await file.text();
                        const data = JSON.parse(text);

                        // Accept both: {person:{name}, debts:[...]} or older: {name, debts:[...]}
                        const personName = data?.person?.name || data?.name || data?.personName;
                        const debts = data?.debts || data?.person?.debts;

                        const res = mergeImportedPerson(personName, debts);
                        if (res.ok) {
                            totalFiles += 1;
                            totalDebts += res.addedDebts || 0;
                        }
                    }

                    saveState();
                    updateAndRender();

                    importResult.className = 'mt-3 text-sm text-status-paid';
                    importResult.textContent = `${translateText('importDone')} (${totalFiles} file(s), ${totalDebts} debt(s))`;
                } catch (e) {
                    importResult.className = 'mt-3 text-sm text-status-negative';
                    importResult.textContent = translateText('importFailed') + (e?.message || e);
                }
            };


            // --- Action Functions ---
            const addPerson = () => { const name = newPersonNameInput.value.trim(); if (name) { persons.push({ id: Date.now(), name: name, debts: [] }); newPersonNameInput.value = ''; addPersonForm.classList.add('hidden'); showAddPersonButton.classList.remove('hidden'); updateAndRender(); } };
            const addDebt = () => { const amount = parseFloat(newDebtAmountInput.value) || 0; const note = newDebtNoteInput.value.trim(); const isOwedToMe = document.querySelector('input[name="newDebtType"]:checked').value === 'owedToMe'; const receipt = newDebtReceiptPreviewContainer.querySelector('img')?.src || null; if (amount > 0 && currentPerson) { const newDebtEntry = { id: Date.now(), amount, note, receipt, isOwedToMe, isPaid: false, date: new Date().toISOString().split('T')[0] }; const personIndex = persons.findIndex(p => p.id === currentPerson.id); if (personIndex !== -1) { if (!persons[personIndex].debts) persons[personIndex].debts = []; persons[personIndex].debts.push(newDebtEntry); newDebtAmountInput.value = ''; newDebtNoteInput.value = ''; newDebtReceiptInput.value = ''; renderReceiptArea(newDebtReceiptPreviewContainer, null, 'new-debt-receipt-input'); document.querySelector('input[name="newDebtType"][value="owedToMe"]').checked = true; confirmAddDebtButton.disabled = true; addDebtForm.classList.add('hidden'); showAddDebtButton.classList.remove('hidden'); updateAndRender(); } } };
            const viewPerson = (personId) => { currentPerson = persons.find(p => p.id === personId) || null; updateAndRender(); };
            const goToHome = () => { currentPerson = null; updateAndRender(); };
            const hideAllOptionPopups = () => { document.querySelectorAll('.options-popup').forEach(popup => popup.classList.add('hidden')); };
            const toggleOptionsPopup = (parentCardDiv) => { const popup = parentCardDiv.querySelector('.options-popup'); if (!popup) return; const isHidden = popup.classList.contains('hidden'); hideAllOptionPopups(); if (isHidden) popup.classList.remove('hidden'); };

            // --- Confirmation Modal Function ---
            function showConfirmation(messageKey, callback) {
                 confirmationMessage.textContent = translateText(messageKey);
                 confirmationCallback = callback;
                 confirmationModal.classList.remove('hidden');
                 applyTranslations();
             }

            // --- Debt Options Modal Function ---
             function openDebtOptionsModal(debtId) {
                selectedDebt = currentPerson?.debts.find(d => d.id === debtId); if (!selectedDebt) return;
                debtOptionsList.innerHTML = '';
                // Edit Button
                const editLi = document.createElement('li'); editLi.innerHTML = `<button><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg> <span data-translate="edit">${translateText('edit')}</span></button>`;
                editLi.querySelector('button').onclick = () => { debtOptionsModal.classList.add('hidden'); openEditDebt(selectedDebt.id); }; debtOptionsList.appendChild(editLi);
                // Toggle Paid Button
                const togglePaidLi = document.createElement('li'); if (selectedDebt.isPaid) { togglePaidLi.innerHTML = `<button class="text-yellow-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> <span data-translate="markUnpaid">${translateText('markUnpaid')}</span></button>`; } else { togglePaidLi.innerHTML = `<button class="text-status-paid"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg> <span data-translate="markPaid">${translateText('markPaid')}</span></button>`; }
                togglePaidLi.querySelector('button').onclick = () => { debtOptionsModal.classList.add('hidden'); requestToggleDebtPaid(selectedDebt.id); }; debtOptionsList.appendChild(togglePaidLi);
                // Delete Button
                const deleteLi = document.createElement('li'); deleteLi.innerHTML = `<button class="text-status-negative"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> <span data-translate="delete">${translateText('delete')}</span></button>`;
                deleteLi.querySelector('button').onclick = () => { debtOptionsModal.classList.add('hidden'); requestDeleteDebt(selectedDebt.id); }; debtOptionsList.appendChild(deleteLi);
                debtOptionsModal.classList.remove('hidden'); applyTranslations();
             }

            // --- Confirmation Logic ---
            const requestToggleDebtPaid = (debtId) => { selectedDebt = currentPerson?.debts.find(d => d.id === debtId); if (!selectedDebt) return; showConfirmation('confirmDebtChange', toggleDebtPaid); };
            const toggleDebtPaid = () => { if (!selectedDebt || !currentPerson) return; const personIndex = persons.findIndex(p => p.id === currentPerson.id); if (personIndex !== -1) { const debtIndex = persons[personIndex].debts.findIndex(d => d.id === selectedDebt.id); if (debtIndex !== -1) persons[personIndex].debts[debtIndex].isPaid = !persons[personIndex].debts[debtIndex].isPaid; updateAndRender(); } selectedDebt = null; };
            const requestDeleteDebt = (debtId) => { selectedDebt = currentPerson?.debts.find(d => d.id === debtId); if (!selectedDebt) return; showConfirmation('confirmDeleteDebtMessage', deleteDebt); }
            const deleteDebt = () => { if (!selectedDebt || !currentPerson) return; const personIndex = persons.findIndex(p => p.id === currentPerson.id); if (personIndex !== -1) { persons[personIndex].debts = persons[personIndex].debts.filter(debt => debt.id !== selectedDebt.id); if (editingDebt?.id === selectedDebt.id) { editDebtModal.classList.add('hidden'); editingDebt = null; } updateAndRender(); } selectedDebt = null; };

            const openEditDebt = (debtId) => { /* ... (same as before) ... */ hideAllOptionPopups(); if (!currentPerson) return; const debt = currentPerson.debts.find(d => d.id === debtId); if (debt) { editingDebt = { ...debt }; editDebtIdInput.value = editingDebt.id; editDebtAmountInput.value = editingDebt.amount; editDebtNoteInput.value = editingDebt.note; document.getElementById('edit-debt-owed-by-me-label').dataset.translateName = currentPerson.name; document.getElementById('edit-debt-owed-by-me-label').dataset.translate = 'debtForPerson'; document.querySelector(`input[name="editDebtType"][value="${editingDebt.isOwedToMe ? 'owedToMe' : 'owedByMe'}"]`).checked = true; renderReceiptArea(editDebtReceiptPreviewContainer, editingDebt.receipt, 'edit-debt-receipt-input'); confirmUpdateDebtButton.disabled = !editingDebt.amount; editDebtModal.classList.remove('hidden'); applyTranslations(); } };
            const updateDebt = () => { /* ... (same as before) ... */ if (!editingDebt || !currentPerson) return; const amount = parseFloat(editDebtAmountInput.value) || 0; const note = editDebtNoteInput.value.trim(); const isOwedToMe = document.querySelector('input[name="editDebtType"]:checked').value === 'owedToMe'; const receipt = editDebtReceiptPreviewContainer.querySelector('img')?.src || null; if (amount > 0) { const personIndex = persons.findIndex(p => p.id === currentPerson.id); if (personIndex !== -1) { const debtIndex = persons[personIndex].debts.findIndex(d => d.id === editingDebt.id); if (debtIndex !== -1) persons[personIndex].debts[debtIndex] = { ...persons[personIndex].debts[debtIndex], amount, note, receipt, isOwedToMe }; editDebtModal.classList.add('hidden'); editingDebt = null; updateAndRender(); } } };
            const openEditPerson = (personId) => { /* ... (same as before) ... */ hideAllOptionPopups(); const person = persons.find(p => p.id === personId); if (person) { editingPersonId = person.id; editPersonIdInput.value = person.id; editPersonNameInput.value = person.name; confirmUpdatePersonButton.disabled = !person.name.trim(); editPersonModal.classList.remove('hidden'); applyTranslations(); editPersonNameInput.focus(); } };
            const updatePerson = () => { /* ... (same as before) ... */ const newName = editPersonNameInput.value.trim(); if (!editingPersonId || !newName) return; const personIndex = persons.findIndex(p => p.id === editingPersonId); if (personIndex !== -1) persons[personIndex].name = newName; editPersonModal.classList.add('hidden'); editingPersonId = null; updateAndRender(); };
            const deletePerson = (personId) => { /* ... (same as before) ... */ hideAllOptionPopups(); const person = persons.find(p => p.id === personId); if (!person) return; if (window.confirm(translateText('confirmDeletePerson', {name: person.name}))) { persons = persons.filter(p => p.id !== personId); if (currentPerson?.id === personId) goToHome(); else updateAndRender(); } };
            const handleFileRead = (file, containerElement, inputId, updateStateCallback) => { /* ... (same as before) ... */ if (file?.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (event) => { const imageDataUrl = event.target.result; renderReceiptArea(containerElement, imageDataUrl, inputId); if (updateStateCallback) updateStateCallback(imageDataUrl); }; reader.onerror = (error) => { console.error("Error reading file:", error); alert("حدث خطأ أثناء قراءة الصورة."); renderReceiptArea(containerElement, null, inputId); }; reader.readAsDataURL(file); } else if (file) { alert("الرجاء اختيار ملف صورة صالح."); document.getElementById(inputId).value = ''; } };
            window.showImage = function(imageUrl) { if (imageUrl) { imageViewerImg.src = imageUrl; imageViewerModal.classList.remove('hidden'); } }
            const printPersonDetails = () => { if (!currentPerson) { alert(translateText('selectPersonToPrint')); return; } console.log("Initiating print..."); window.print(); };

            // --- Event Listeners ---
            menuButton.addEventListener('click', () => toggleSidebar(true)); sidebarOverlay.addEventListener('click', () => toggleSidebar(false)); sidebar.querySelectorAll('a, button.sidebar-item, select').forEach(item => { if(item.tagName !== 'SELECT' && item.id !== 'dark-mode-toggle') { item.addEventListener('click', () => toggleSidebar(false)); } });
            darkModeToggle.addEventListener('change', () => toggleDarkMode()); currencySelect.addEventListener('change', (e) => setCurrency(e.target.value)); languageSelect.addEventListener('change', (e) => setLanguage(e.target.value)); showAboutButton.addEventListener('click', () => { aboutModal.classList.remove('hidden'); applyTranslations(); });

            // Import/Export Debts
            openImportExportBtn.addEventListener('click', openImportExportModal);
            closeImportExportBtn.addEventListener('click', closeImportExportModal);
            importExportModal.addEventListener('click', (e) => { if (e.target === importExportModal) closeImportExportModal(); });

            tabImportBtn.addEventListener('click', () => setImportExportTab('import'));
            tabExportBtn.addEventListener('click', () => { refreshExportPersonsList(); setImportExportTab('export'); });

            selectAllExportBtn.addEventListener('click', () => {
                exportPersonsList.querySelectorAll('.export-person-checkbox').forEach(c => c.checked = true);
            });
            clearAllExportBtn.addEventListener('click', () => {
                exportPersonsList.querySelectorAll('.export-person-checkbox').forEach(c => c.checked = false);
            });

            doExportBtn.addEventListener('click', exportSelectedPersons);
            doImportBtn.addEventListener('click', importDebtsFiles);
            requestPersistentBtn.addEventListener('click', async () => { await requestPersistentStorage(); await updateStorageInfoUI(); });
            showAddPersonButton.addEventListener('click', () => { addPersonForm.classList.remove('hidden'); showAddPersonButton.classList.add('hidden'); newPersonNameInput.focus(); }); cancelAddPersonButton.addEventListener('click', () => { addPersonForm.classList.add('hidden'); showAddPersonButton.classList.remove('hidden'); newPersonNameInput.value = ''; }); confirmAddPersonButton.addEventListener('click', addPerson); newPersonNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addPerson(); }); showAddDebtButton.addEventListener('click', () => { addDebtForm.classList.remove('hidden'); showAddDebtButton.classList.add('hidden'); newDebtAmountInput.focus(); newDebtAmountInput.value = ''; newDebtNoteInput.value = ''; newDebtReceiptInput.value = ''; renderReceiptArea(newDebtReceiptPreviewContainer, null, 'new-debt-receipt-input'); document.querySelector('input[name="newDebtType"][value="owedToMe"]').checked = true; confirmAddDebtButton.disabled = true; applyTranslations(); }); cancelAddDebtButton.addEventListener('click', () => { addDebtForm.classList.add('hidden'); showAddDebtButton.classList.remove('hidden'); }); confirmAddDebtButton.addEventListener('click', addDebt); newDebtAmountInput.addEventListener('input', () => { confirmAddDebtButton.disabled = !newDebtAmountInput.value || parseFloat(newDebtAmountInput.value) <= 0; }); closePersonViewButton.addEventListener('click', goToHome);
            cancelConfirmationBtn.addEventListener('click', () => { confirmationModal.classList.add('hidden'); confirmationCallback = null; selectedDebt = null; }); confirmActionBtn.addEventListener('click', () => { if (typeof confirmationCallback === 'function') { confirmationCallback(); } confirmationModal.classList.add('hidden'); confirmationCallback = null; });
            cancelDebtOptionsBtn.addEventListener('click', () => { debtOptionsModal.classList.add('hidden'); selectedDebt = null; }); debtOptionsModal.addEventListener('click', (e) => { if(e.target === debtOptionsModal) { debtOptionsModal.classList.add('hidden'); selectedDebt = null; } });
            cancelEditDebtButton.addEventListener('click', () => { editDebtModal.classList.add('hidden'); editingDebt = null; }); confirmUpdateDebtButton.addEventListener('click', updateDebt); deleteDebtFromEditButton.addEventListener('click', () => { if(editingDebt) requestDeleteDebt(editingDebt.id); editDebtModal.classList.add('hidden'); }); editDebtAmountInput.addEventListener('input', () => { confirmUpdateDebtButton.disabled = !editDebtAmountInput.value || parseFloat(editDebtAmountInput.value) <= 0; if(editingDebt) editingDebt.amount = parseFloat(editDebtAmountInput.value) || 0; }); editDebtNoteInput.addEventListener('input', () => { if(editingDebt) editingDebt.note = editDebtNoteInput.value; }); editDebtReceiptInput.addEventListener('change', (e) => { handleFileRead(e.target.files[0], editDebtReceiptPreviewContainer, 'edit-debt-receipt-input', (imageDataUrl) => { if (editingDebt) editingDebt.receipt = imageDataUrl; }); }); newDebtReceiptInput.addEventListener('change', (e) => { handleFileRead(e.target.files[0], newDebtReceiptPreviewContainer, 'new-debt-receipt-input'); }); cancelEditPersonButton.addEventListener('click', () => { editPersonModal.classList.add('hidden'); editingPersonId = null; }); confirmUpdatePersonButton.addEventListener('click', updatePerson); editPersonNameInput.addEventListener('input', () => { confirmUpdatePersonButton.disabled = !editPersonNameInput.value.trim(); }); editPersonNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !confirmUpdatePersonButton.disabled) updatePerson(); }); document.addEventListener('click', (e) => { if (!e.target.closest('.options-toggle') && !e.target.closest('.options-popup') && !e.target.closest('#debt-options-modal .modal-content')) { hideAllOptionPopups(); debtOptionsModal.classList.add('hidden'); } }); printButtonDetails.addEventListener('click', printPersonDetails);

            // --- Initial Setup ---
            async function initializeApp() {
                persons = await loadPersonsFromStorage();
                toggleDarkMode(isDarkMode);
                currencySelect.value = currentCurrency;
                languageSelect.value = currentLang;
                updateAndRender();
            }
            initializeApp();
        });
    </script>

</body>
</html>